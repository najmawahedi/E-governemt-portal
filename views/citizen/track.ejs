<h2>Track Your Requests</h2>

<% if (requests.length === 0) { %>
<div class="alert alert-info">
  You haven't submitted any service requests yet.
  <a
    href="/citizen/apply?citizen_id=<%= user.id %>&name=<%= encodeURIComponent(user.name) %>"
    class="alert-link"
  >
    Apply for a service now
  </a>
</div>
<% } else { %>
<table class="table table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>Service</th>
      <th>Department</th>
      <th>Fee</th>
      <th>Status</th>
      <th>Created At</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <% requests.forEach(r => { %>
    <tr>
      <td><%= r.id %></td>
      <td><%= r.service %></td>
      <td><%= r.department %></td>
      <td>$<%= r.fee || 0 %></td>
      <td>
        <span
          class="badge <% if (r.status === 'approved') { %>bg-success<% } %> <% if (r.status === 'rejected') { %>bg-danger<% } %> <% if (r.status === 'under_review') { %>bg-info<% } %> <% if (r.status === 'submitted') { %>bg-warning<% } %>"
        >
          <%= r.status %>
        </span>
      </td>
      <td><%= new Date(r.created_at).toLocaleString() %></td>
      <td>
        <!-- ✅ PAY NOW BUTTON: Show only for submitted requests with fees -->
        <% if (r.status === 'submitted' && r.fee > 0) { %>
        <a
          href="/payments?request_id=<%= r.id %>&citizen_id=<%= user.id %>&name=<%= encodeURIComponent(user.name) %>"
          class="btn btn-sm btn-warning"
        >
          Pay Now
        </a>
        <% } else if (r.status === 'submitted' && r.fee === 0) { %>
        <span class="text-muted">No payment required</span>
        <% } else { %>
        <span class="text-muted">-</span>
        <% } %>
      </td>
    </tr>
    <% }) %>
  </tbody>
</table>
<% } %>
  
<div class="mt-3">
  <a
    href="/citizen/dashboard?citizen_id=<%= user.id %>&name=<%= encodeURIComponent(user.name) %>"
    class="btn btn-secondary"
  >
    ← Back to Dashboard
  </a>
</div>
